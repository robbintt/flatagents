# Character Card Chat Machine
# Loads a character card PNG and enables chat with the character

spec: flatmachine
spec_version: "0.2.0"

data:
  name: character-card-chat
  
  context:
    # Card data loaded from PNG by hooks
    card_name: null
    card_description: null
    card_personality: null
    card_scenario: null
    card_system_prompt: null
    card_first_mes: null
    card_mes_example: null
    post_history_instructions: null
    # User identity
    user_name: "User"
    user_persona: null
    # Settings
    no_system_prompt: false
    auto_user: false
    # Chat state
    user_message: null
    assistant_message: null
    messages: []
  
  agents:
    responder: ./responder.yml
  
  states:
    start:
      type: initial
      action: load_card
      transitions:
        - to: greet
    
    greet:
      action: show_greeting
      transitions:
        - to: await_input
    
    await_input:
      action: get_user_input
      transitions:
        - condition: "context.user_message == '/quit'"
          to: done
        - to: respond
    
    respond:
      agent: responder
      input:
        card_name: "{{ context.card_name }}"
        card_description: "{{ context.card_description }}"
        card_personality: "{{ context.card_personality }}"
        card_scenario: "{{ context.card_scenario }}"
        card_system_prompt: "{{ context.card_system_prompt }}"
        card_mes_example: "{{ context.card_mes_example }}"
        post_history_instructions: "{{ context.post_history_instructions }}"
        messages: "{{ context.messages | tojson }}"
        user_message: "{{ context.user_message }}"
        user_name: "{{ context.user_name }}"
        user_persona: "{{ context.user_persona }}"
        no_system_prompt: "{{ context.no_system_prompt }}"
      output_to_context:
        assistant_message: "{{ output.response }}"
      transitions:
        - to: update_history
    
    update_history:
      action: update_chat_history
      transitions:
        - to: await_input
    
    done:
      type: final
      output:
        character: "{{ context.card_name }}"
        turns: "{{ context.messages | length }}"

metadata:
  description: "Chat with a character from a V1/V2/V3 character card"
  tags: ["character-card", "chat", "roleplay", "sillytavern"]

# Chapter Writer Peer Machine
# Draft → Critique → Revise loop for a single chapter

spec: flatmachine
spec_version: "0.7.7"

data:
  name: chapter-writer
  profiles: ./profiles.yml

  context:
    genre: "{{ input.genre }}"
    title: "{{ input.title }}"
    chapter_number: "{{ input.chapter_number }}"
    chapter_outline: "{{ input.chapter_outline }}"
    previous_chapters: "{{ input.previous_chapters | default([]) }}"
    raw_draft: null
    draft: null
    raw_critique: null
    critique: null
    raw_revision: null
    final_chapter: null

  agents:
    drafter: ./drafter.yml
    chapter_extractor: ./chapter_extractor.yml
    critic: ./critic.yml
    feedback_extractor: ./feedback_extractor.yml
    reviser: ./reviser.yml
    revision_extractor: ./revision_extractor.yml

  states:
    start:
      type: initial
      transitions:
        - to: draft

    draft:
      agent: drafter
      input:
        genre: "{{ context.genre }}"
        title: "{{ context.title }}"
        chapter_number: "{{ context.chapter_number }}"
        outline: "{{ context.chapter_outline }}"
        previous_summary: "{{ context.previous_chapters[-1][:500] if context.previous_chapters else 'This is the first chapter.' }}"
      output_to_context:
        raw_draft: "{{ output.content }}"
      transitions:
        - to: extract_draft

    extract_draft:
      agent: chapter_extractor
      execution:
        type: retry
        backoffs: [2, 8, 16, 35]
        jitter: 0.1
      input:
        text: "{{ context.raw_draft }}"
      output_to_context:
        draft: "{{ output.chapter_text }}"
      transitions:
        - to: critique

    critique:
      agent: critic
      input:
        genre: "{{ context.genre }}"
        chapter_text: "{{ context.draft }}"
        chapter_outline: "{{ context.chapter_outline }}"
      output_to_context:
        raw_critique: "{{ output.content }}"
      transitions:
        - to: extract_critique

    extract_critique:
      agent: feedback_extractor
      execution:
        type: retry
        backoffs: [2, 8, 16, 35]
        jitter: 0.1
      input:
        text: "{{ context.raw_critique }}"
      output_to_context:
        critique: "{{ output.feedback }}"
      transitions:
        - to: revise

    revise:
      agent: reviser
      input:
        chapter_text: "{{ context.draft }}"
        critique: "{{ context.critique }}"
      output_to_context:
        raw_revision: "{{ output.content }}"
      transitions:
        - to: extract_revision

    extract_revision:
      agent: revision_extractor
      execution:
        type: retry
        backoffs: [2, 8, 16, 35]
        jitter: 0.1
      input:
        text: "{{ context.raw_revision }}"
      output_to_context:
        final_chapter: "{{ output.revised_text }}"
      transitions:
        - to: done

    done:
      type: final
      output:
        final_chapter: "{{ context.final_chapter }}"

metadata:
  description: "Peer machine for draft-critique-revise chapter loop"

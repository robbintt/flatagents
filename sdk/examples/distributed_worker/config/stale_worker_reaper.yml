spec: flatmachine
spec_version: "0.8.3"

data:
  name: stale_worker_reaper
  
  context:
    pool_id: "{{ input.pool_id | default('default') }}"
    stale_threshold_seconds: "{{ input.stale_threshold_seconds | default(60) }}"
  
  hooks:
    file: "../python/hooks.py"
    class: "DistributedWorkerHooks"
  
  states:
    start:
      type: initial
      transitions:
        - to: find_stale_workers
    
    find_stale_workers:
      action: list_stale_workers
      output_to_context:
        stale_workers: "{{ output.workers }}"
      transitions:
        - condition: "context.stale_workers | length == 0"
          to: done
        - to: reap_workers
    
    reap_workers:
      foreach: "{{ context.stale_workers }}"
      as: worker
      action: reap_worker
      transitions:
        - to: done
    
    done:
      type: final
      output:
        reaped_count: "{{ context.stale_workers | length }}"
        stale_workers: "{{ context.stale_workers }}"

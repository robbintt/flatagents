# Refiner Peer Machine (Self-Judging Loop)
# Creates and iteratively improves summary until quality threshold met
# Contains 2 agents: synthesizer (creates summary) and critic (judges quality)
# Loops up to 3 times until quality_score >= 8

spec: flatmachine
spec_version: "1.0.0"

data:
  name: refiner
  profiles: ./profiles.yml
  
  context:
    # Input from parent (now receives full text analyses)
    title: "{{ input.title }}"
    authors: "{{ input.authors }}"
    analysis: "{{ input.analysis }}"
    reference_count: "{{ input.reference_count }}"
    # Refinement state
    summary: null
    critique_text: null
    iteration: 0
  
  agents:
    synthesizer: ./synthesizer.yml
    critic: ./critic.yml
  
  states:
    start:
      type: initial
      transitions:
        - to: synthesize

    # Generate summary from analysis
    synthesize:
      agent: synthesizer
      execution:
        type: retry
        backoffs: [2, 8]
      input:
        title: "{{ context.title }}"
        authors: "{{ context.authors }}"
        key_findings: "{{ context.analysis }}"
        methodology: "{{ context.analysis }}"
        contributions: "{{ context.analysis }}"
        technical_details: "{{ context.analysis }}"
        results: "{{ context.analysis }}"
        reference_count: "{{ context.reference_count }}"
        previous_summary: "{{ context.summary }}"
        critique: "{{ context.critique_text }}"
        iteration: "{{ context.iteration }}"
      output_to_context:
        summary: content
        iteration: "{{ context.iteration + 1 }}"
      transitions:
        - to: critique

    # Judge the summary quality
    critique:
      agent: critic
      execution:
        type: retry
        backoffs: [2, 8]
      input:
        title: "{{ context.title }}"
        summary: "{{ context.summary }}"
        key_findings: "{{ context.analysis }}"
        methodology: "{{ context.analysis }}"
      output_to_context:
        critique_text: content
      transitions:
        # Loop max 3 times (can't parse score from text in machine)
        - condition: "context.iteration >= 3"
          to: done
        - to: synthesize

    done:
      type: final
      output:
        summary: "{{ context.summary }}"

metadata:
  description: "Self-judging refinement loop for summary quality"

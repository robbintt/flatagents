{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$ref": "#/definitions/SDKRuntimeWrapper",
  "definitions": {
    "SDKRuntimeWrapper": {
      "type": "object",
      "properties": {
        "spec": {
          "type": "string",
          "const": "flatagents-runtime"
        },
        "spec_version": {
          "type": "string",
          "const": "0.9.0"
        },
        "execution_lock": {
          "$ref": "#/definitions/ExecutionLock"
        },
        "persistence_backend": {
          "$ref": "#/definitions/PersistenceBackend"
        },
        "result_backend": {
          "$ref": "#/definitions/ResultBackend"
        },
        "execution_config": {
          "$ref": "#/definitions/ExecutionConfig"
        },
        "machine_hooks": {
          "$ref": "#/definitions/MachineHooks"
        },
        "llm_backend": {
          "$ref": "#/definitions/LLMBackend"
        },
        "machine_invoker": {
          "$ref": "#/definitions/MachineInvoker"
        },
        "backend_config": {
          "$ref": "#/definitions/BackendConfig"
        },
        "machine_snapshot": {
          "$ref": "#/definitions/MachineSnapshot"
        },
        "registration_backend": {
          "$ref": "#/definitions/RegistrationBackend"
        },
        "work_backend": {
          "$ref": "#/definitions/WorkBackend"
        }
      },
      "required": [
        "spec",
        "spec_version"
      ],
      "additionalProperties": false,
      "description": "Wrapper interface for JSON schema generation. Groups all runtime interfaces that SDKs must implement."
    },
    "ExecutionLock": {
      "type": "object",
      "additionalProperties": false,
      "description": "FlatAgents Runtime Interface Spec ==================================\n\nThis file defines the runtime interfaces that SDKs MUST implement to be considered compliant. These are NOT configuration schemas (see flatagent.d.ts and flatmachine.d.ts for those).\n\nREQUIRED IMPLEMENTATIONS:\n-------------------------   - ExecutionLock: NoOpLock (MUST), LocalFileLock (SHOULD)   - PersistenceBackend: MemoryBackend (MUST), LocalFileBackend (SHOULD)   - ResultBackend: InMemoryResultBackend (MUST)   - ExecutionType: Default, Retry, Parallel, MDAPVoting (MUST)   - MachineHooks: Base interface (MUST)   - RegistrationBackend: SQLiteRegistrationBackend (MUST), MemoryRegistrationBackend (SHOULD)   - WorkBackend: SQLiteWorkBackend (MUST), MemoryWorkBackend (SHOULD)\n\nOPTIONAL IMPLEMENTATIONS:\n-------------------------   - Distributed backends (Redis, Postgres, etc.)   - LLMBackend (SDK may use native provider SDKs)\n\nEXECUTION LOCKING:\n------------------ Prevents concurrent execution of the same machine instance.\n\nSDKs MUST provide:   - NoOpLock: For when locking is handled externally or disabled\n\nSDKs SHOULD provide:   - LocalFileLock: For single-node deployments using fcntl/flock\n\nDistributed deployments should implement Redis/Consul/etcd locks.\n\nPERSISTENCE BACKEND:\n-------------------- Storage backend for machine checkpoints.\n\nSDKs MUST provide:   - MemoryBackend: For testing and ephemeral runs\n\nSDKs SHOULD provide:   - LocalFileBackend: For durable local storage with atomic writes\n\nRESULT BACKEND:\n--------------- Inter-machine communication via URI-addressed results.\n\nURI format: flatagents://{execution_id}/{path}   - path is typically \"result\" or \"checkpoint\"\n\nSDKs MUST provide:   - InMemoryResultBackend: For single-process execution\n\nEXECUTION TYPES:\n---------------- Execution strategy for agent calls.\n\nSDKs MUST implement all four types:   - default: Single call, no retry   - retry: Configurable backoffs with jitter   - parallel: Run N samples, return all successes   - mdap_voting: Multi-sample with consensus voting\n\nMACHINE HOOKS:\n-------------- Extension points for machine execution. All methods are optional and can be sync or async.\n\nSDKs SHOULD provide:   - WebhookHooks: Send events to HTTP endpoint   - CompositeHooks: Combine multiple hook implementations\n\nLLM BACKEND (OPTIONAL):\n----------------------- Abstraction over LLM providers.\n\nThis interface is OPTIONAL - SDKs may use provider SDKs directly. Useful for:   - Unified retry/monitoring across providers   - Provider-agnostic code   - Testing with mock backends\n\nMACHINE INVOKER:\n---------------- Interface for invoking peer machines. Used internally by FlatMachine for `machine:` and `launch:` states.\n\nBACKEND CONFIGURATION:\n---------------------- Backend configuration for machine settings.\n\nExample in YAML:   settings:     backends:       persistence: local       locking: none       results: memory"
    },
    "PersistenceBackend": {
      "type": "object",
      "additionalProperties": false
    },
    "ResultBackend": {
      "type": "object",
      "additionalProperties": false
    },
    "ExecutionConfig": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "default",
            "retry",
            "parallel",
            "mdap_voting"
          ]
        },
        "backoffs": {
          "type": "array",
          "items": {
            "type": "number"
          }
        },
        "jitter": {
          "type": "number"
        },
        "n_samples": {
          "type": "number"
        },
        "k_margin": {
          "type": "number"
        },
        "max_candidates": {
          "type": "number"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "MachineHooks": {
      "type": "object",
      "additionalProperties": false
    },
    "LLMBackend": {
      "type": "object",
      "properties": {
        "totalCost": {
          "type": "number",
          "description": "Total cost accumulated across all calls."
        },
        "totalApiCalls": {
          "type": "number",
          "description": "Total API calls made."
        }
      },
      "required": [
        "totalCost",
        "totalApiCalls"
      ],
      "additionalProperties": false
    },
    "MachineInvoker": {
      "type": "object",
      "additionalProperties": false
    },
    "BackendConfig": {
      "type": "object",
      "properties": {
        "persistence": {
          "type": "string",
          "enum": [
            "memory",
            "local",
            "redis",
            "postgres",
            "s3"
          ],
          "description": "Checkpoint storage. Default: memory"
        },
        "locking": {
          "type": "string",
          "enum": [
            "none",
            "local",
            "redis",
            "consul"
          ],
          "description": "Execution locking. Default: none"
        },
        "results": {
          "type": "string",
          "enum": [
            "memory",
            "redis"
          ],
          "description": "Inter-machine results. Default: memory"
        },
        "registration": {
          "type": "string",
          "enum": [
            "memory",
            "sqlite",
            "redis"
          ],
          "description": "Worker registration. Default: memory"
        },
        "work": {
          "type": "string",
          "enum": [
            "memory",
            "sqlite",
            "redis"
          ],
          "description": "Work pool. Default: memory"
        },
        "sqlite_path": {
          "type": "string",
          "description": "Path for sqlite backends (registration and work share this)"
        }
      },
      "additionalProperties": false
    },
    "MachineSnapshot": {
      "type": "object",
      "properties": {
        "execution_id": {
          "type": "string"
        },
        "machine_name": {
          "type": "string"
        },
        "spec_version": {
          "type": "string"
        },
        "current_state": {
          "type": "string"
        },
        "context": {
          "type": "object"
        },
        "step": {
          "type": "number"
        },
        "created_at": {
          "type": "string"
        },
        "event": {
          "type": "string"
        },
        "output": {
          "type": "object"
        },
        "total_api_calls": {
          "type": "number"
        },
        "total_cost": {
          "type": "number"
        },
        "parent_execution_id": {
          "type": "string"
        },
        "pending_launches": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/LaunchIntent"
          }
        }
      },
      "required": [
        "execution_id",
        "machine_name",
        "spec_version",
        "current_state",
        "context",
        "step",
        "created_at"
      ],
      "additionalProperties": false
    },
    "LaunchIntent": {
      "type": "object",
      "properties": {
        "execution_id": {
          "type": "string"
        },
        "machine": {
          "type": "string"
        },
        "input": {
          "type": "object"
        },
        "launched": {
          "type": "boolean"
        }
      },
      "required": [
        "execution_id",
        "machine",
        "input",
        "launched"
      ],
      "additionalProperties": false
    },
    "RegistrationBackend": {
      "type": "object",
      "additionalProperties": false,
      "description": "REGISTRATION BACKEND:\n--------------------- Worker lifecycle management for distributed execution.\n\nSDKs MUST provide:   - SQLiteRegistrationBackend: For local deployments\n\nSDKs SHOULD provide:   - MemoryRegistrationBackend: For testing\n\nImplementation notes:   - Time units: Python reference SDK uses seconds for all interval values   - Stale threshold: SDKs SHOULD default to 2Ã— heartbeat_interval if not specified"
    },
    "WorkBackend": {
      "type": "object",
      "additionalProperties": false,
      "description": "WORK BACKEND:\n------------- Work distribution via named pools with atomic claim.\n\nSDKs MUST provide:   - SQLiteWorkBackend: For local deployments\n\nSDKs SHOULD provide:   - MemoryWorkBackend: For testing\n\nImplementation notes:   - Atomic claim: SDKs MUST ensure no two workers can claim the same job   - Test requirements: Include concurrent claim race condition tests"
    }
  }
}
